<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Firebase Push Demo</title>
</head>
<body>
    <h1>Firebase Web Push 範例</h1>
    <button id="notifiyBtn1">點我發通知</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>


    <script>
        // Firebase 專案設定
        const firebaseConfig = {
            apiKey: "AIzaSyCppoyrgeZsWad4Zss93GdjjTdlCybn5Zk",
            authDomain: "so101-f8079.firebaseapp.com",
            projectId: "so101-f8079",
            storageBucket: "so101-f8079.appspot.com",
            messagingSenderId: "1035056506659",
            appId: "1:1035056506659:web:93a76861ae259218bb8e96",
        };

        // 初始化 Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // 存放取得的 Token
        let currentToken = null;

        // 請求推播權限並取得 token
        async function initFCM() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    currentToken = await messaging.getToken({ vapidKey: 'BGfelfswFUZMdLRyivB1nLI4QNKQIR7ZGP1_9AcDWq1GkTJHLwcUNPPcQAgXk1xH2mSrW5UH-RX-5fX1Z8XejBw' });
                    console.log("取得Token:", currentToken);

                    // 將Token寫入Firebase Realtime Database
                    await fetch('https://so101-f8079-default-rtdb.firebaseio.com/tokens/' + currentToken + '.json', {
                        method: 'PUT',
                        body: JSON.stringify(true)
                    });
                } else {
                    console.log("推播權限被拒絕");
                }
            } catch (e) {
                console.error("初始化推播失敗", e);
            }
        }

        // 監聽按鈕點擊並寫入 notify node 通知後端
        function setupButton() {
            document.getElementById('btnNotify').onclick = async (e) => {
                try {
                    await fetch('https://so101-f8079-default-rtdb.firebaseio.com/notify.json', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            time: Date.now(),
                            buttonId: e.target.id // 傳送按鈕的ID
                        })
                    });
                    console.log("通知寫入成功");
                } catch (e) {
                    console.error("通知寫入失敗", e);
                }
            };
        }

        // 初始化
        initFCM();
        setupButton();

        // 接收前台訊息
        messaging.onMessage((payload) => {
            console.log("收到訊息:", payload);
            new Notification(payload.notification.title, {
                body: payload.notification.body
            });
        });
    </script>
</body>
</html>
